{"version":3,"sources":["../src/listenDevices.js"],"names":["delay","listenDevicesPollingSkip","events","EventEmitter","setMaxListeners","listDevices","flatDevice","d","path","getFlatDevices","Set","map","getDeviceByPaths","paths","find","includes","lastDevices","poll","changeFound","currentDevices","newDevices","filter","length","emit","removeDevices","debouncedPoll","attachDetected","device","usb","on","detachDetected","stop","cancel","removeListener"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from \"events\";\nimport { getDevices } from \"@ledgerhq/hw-transport-node-hid-noevents\";\nimport { log } from \"@ledgerhq/logs\";\nimport usb from \"usb\";\nimport debounce from \"lodash/debounce\";\n\nexport default (\n  delay: number,\n  listenDevicesPollingSkip: () => boolean\n): ({\n  events: EventEmitter,\n  stop: () => void\n}) => {\n  const events = new EventEmitter();\n  events.setMaxListeners(0);\n\n  let listDevices = getDevices();\n\n  const flatDevice = d => d.path;\n\n  const getFlatDevices = () => [\n    ...new Set(getDevices().map(d => flatDevice(d)))\n  ];\n\n  const getDeviceByPaths = paths =>\n    listDevices.find(d => paths.includes(flatDevice(d)));\n\n  let lastDevices = getFlatDevices();\n\n  const poll = () => {\n    if (!listenDevicesPollingSkip()) {\n      log(\"hid-listen\", \"Polling for added or removed devices\");\n\n      let changeFound = false;\n      const currentDevices = getFlatDevices();\n      const newDevices = currentDevices.filter(d => !lastDevices.includes(d));\n\n      if (newDevices.length > 0) {\n        log(\"hid-listen\", \"New device found:\", newDevices);\n\n        listDevices = getDevices();\n        events.emit(\"add\", getDeviceByPaths(newDevices));\n\n        changeFound = true;\n      } else {\n        log(\"hid-listen\", \"No new device found\");\n      }\n\n      const removeDevices = lastDevices.filter(\n        d => !currentDevices.includes(d)\n      );\n\n      if (removeDevices.length > 0) {\n        log(\"hid-listen\", \"Removed device found:\", removeDevices);\n\n        events.emit(\"remove\", getDeviceByPaths(removeDevices));\n        listDevices = listDevices.filter(\n          d => !removeDevices.includes(flatDevice(d))\n        );\n\n        changeFound = true;\n      } else {\n        log(\"hid-listen\", \"No removed device found\");\n      }\n\n      if (changeFound) {\n        lastDevices = currentDevices;\n      }\n    } else {\n      log(\"hid-listen\", \"Polling skipped, re-debouncing\");\n      debouncedPoll();\n    }\n  };\n\n  const debouncedPoll = debounce(poll, delay);\n\n  const attachDetected = device => {\n    log(\"hid-listen\", \"Device add detected:\", device);\n\n    debouncedPoll();\n  };\n  usb.on(\"attach\", attachDetected);\n  log(\"hid-listen\", \"attach listener added\");\n\n  const detachDetected = device => {\n    log(\"hid-listen\", \"Device removal detected:\", device);\n\n    debouncedPoll();\n  };\n  usb.on(\"detach\", detachDetected);\n  log(\"hid-listen\", \"detach listener added\");\n\n  return {\n    stop: () => {\n      log(\n        \"hid-listen\",\n        \"Stop received, removing listeners and cancelling pending debounced polls\"\n      );\n      debouncedPoll.cancel();\n      usb.removeListener(\"attach\", attachDetected);\n      usb.removeListener(\"detach\", detachDetected);\n    },\n    events\n  };\n};\n"],"file":"listenDevices.js"}